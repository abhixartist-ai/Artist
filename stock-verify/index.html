<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chassis Verification</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Roboto, sans-serif;
  margin:0;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}
.container{
  max-width:1100px;
  margin:15px auto;
  background:#fff;
  border-radius:12px;
  padding:15px;
  box-shadow:0 8px 25px rgba(0,0,0,.2);
}
h2{text-align:center;margin:10px 0;color:#333}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
input,button{
  padding:10px;
  border-radius:6px;
  font-size:15px;
}
input{border:1px solid #ccc}
button{
  border:none;
  background:#667eea;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#556cd6}
#statusBox{
  margin:10px auto;
  width:260px;
  height:38px;
  line-height:38px;
  text-align:center;
  font-weight:700;
  color:#fff;
  border-radius:6px;
}
.table-wrap{overflow-x:auto}
table{
  border-collapse:collapse;
  width:100%;
  margin-top:10px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  font-size:14px;
  white-space:nowrap;
}
th{background:#f1f1f1}
tr.single-found{background:#c6f6c6!important}
tr.duplicate-found{background:#ffe699!important}
</style>
</head>

<body>
<div class="container">
  <h2>Stock Physical Verification</h2>
  <div id="statusBox">Status</div>

  <div class="controls">
    <input type="file" id="fileInput" accept=".xls,.xlsx">
    <input type="text" id="searchBox" placeholder="Enter Chassis Number">
    <button onclick="searchChassis()">Verify</button>
    <button onclick="downloadExcelWithSummary()">Save & Summary</button>
  </div>

  <div class="table-wrap">
    <table id="dataTable"></table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<script>
let excelData=[];
const table=document.getElementById('dataTable');
let dirty=false;

window.addEventListener('beforeunload',e=>{
  if(dirty){e.preventDefault();e.returnValue='';}
});

document.getElementById('fileInput').addEventListener('change',function(){
  const file=this.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      excelData=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});

      if(excelData.length<2){
        alert('Excel me kam se kam heading + 1 row honi chahiye');
        return;
      }

      renderTable();
      dirty=false;
    }catch(err){
      alert('Invalid Excel file');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
});

function renderTable(){
  table.innerHTML='';
  excelData.forEach((row,i)=>{
    const tr=document.createElement('tr');
    row.forEach(cell=>{
      const el=document.createElement(i===0?'th':'td');
      el.textContent=cell;
      tr.appendChild(el);
    });
    table.appendChild(tr);
  });
}

function searchChassis(){
  const val=document.getElementById('searchBox').value.trim();
  if(!val) return;

  const rows=table.rows;
  const status=document.getElementById('statusBox');

  for(let i=1;i<rows.length;i++){
    if(!rows[i].classList.contains('single-found')){
      rows[i].classList.remove('duplicate-found');
    }
  }

  let matches=[];
  for(let i=1;i<rows.length;i++){
    const cell=rows[i].cells[1];
    if(cell && cell.textContent.includes(val)) matches.push(rows[i]);
  }

  if(matches.length===0){
    status.textContent='Not Found';
    status.style.background='red';
    dirty=true;
    return;
  }

  if(matches.length===1){
    status.textContent='Verified';
    status.style.background='green';
    matches[0].classList.add('single-found');
  }else{
    status.textContent='Duplicate';
    status.style.background='orange';
    matches.forEach(r=>{
      if(!r.classList.contains('single-found')){
        r.classList.add('duplicate-found');
      }
    });
  }
  dirty=true;
}

function downloadExcelWithSummary(){
  if(table.rows.length<2){
    alert('No data to save');
    return;
  }

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(table);

  if(!ws['!ref']){
    alert('Nothing to export');
    return;
  }

  const range=XLSX.utils.decode_range(ws['!ref']);
  let v=0,d=0,n=0;

  for(let r=1;r<=range.e.r;r++){
    const tr=table.rows[r];
    let fill;

    if(tr.classList.contains('single-found')){fill={fgColor:{rgb:'C6F6C6'}};v++;}
    else if(tr.classList.contains('duplicate-found')){fill={fgColor:{rgb:'FFE699'}};d++;}
    else{fill={fgColor:{rgb:'F4CCCC'}};n++;}

    for(let c=0;c<=range.e.c;c++){
      const ref=XLSX.utils.encode_cell({r,c});
      if(ws[ref]) ws[ref].s={fill};
    }
  }

  ws['!cols']=Array.from({length:range.e.c+1},()=>({wch:20}));
  XLSX.utils.book_append_sheet(wb,ws,'Verification');

  const sum=[
    ['Status','Count'],
    ['Verified',v],
    ['Duplicate',d],
    ['Not Found',n],
    ['Total Rows',v+d+n]
  ];

  const wsS=XLSX.utils.aoa_to_sheet(sum);
  wsS['!cols']=[{wch:20},{wch:15}];

  ['C6F6C6','FFE699','F4CCCC'].forEach((c,i)=>{
    for(let j=0;j<2;j++){
      const ref=XLSX.utils.encode_cell({r:i+1,c:j});
      if(wsS[ref]) wsS[ref].s={fill:{fgColor:{rgb:c}}};
    }
  });

  XLSX.utils.book_append_sheet(wb,wsS,'Summary');
  XLSX.writeFile(wb,'verified_stock_with_summary.xlsx');
  dirty=false;
}
</script>
</body>
</html>